<?php
include_once './../../../vendor/mevdschee/php-crud-api/api.include.php';

use Tqdev\PhpCrudApi\Api;
use Tqdev\PhpCrudApi\Config;
use Tqdev\PhpCrudApi\RequestFactory;
use Tqdev\PhpCrudApi\ResponseFactory;
use Tqdev\PhpCrudApi\ResponseUtils;

$config = new Config([
    'middlewares'=>'dbAuth,customization,multiTenancy',
    'customization.beforeHandler' => function ($operation, $tableName, $response, $environment) {
        if ($tableName==='upload') {
            $body=$response->getParsedBody();
            file_put_contents('./files/test.pdf',base64_decode($body->image));
            $body->image="tit";
            return $response->withParsedBody($body);
        }
        /*if ($tableName==='note') {
            $body=$response->getParsedBody();
            $body->note=json_encode($_SESSION);//['id'];
            return $response->withParsedBody($body);
        }*/
        return $response;
    },
    'multiTenancy.handler' => function ($operation, $tableName) {
        return  $tableName==='note' ? ['user_id' => $_SESSION['user']['id']] :[];
    },
    "dbAuth.mode"=>"required",
    "dbAuth.usersTable"=>"user",
    "dbAuth.usernameColumn"=>"login",
    "dbAuth.passwordColumn"=>"pass",
    "dbAuth.returnedColumns"=>"",
    "dbAuth.registerUser"=>"1",
    "dbAuth.passwordLength"=>"6",
    "dbAuth.sessionName"=>"user_id",
    'driver' => 'sqlite',
    'address' => './test.db',
    'username' => '',
    'password' => '',
    'database' => './test.db'
    ,'debug' => true
]);
$request = RequestFactory::fromGlobals();
$api = new Api($config);
$response = $api->handle($request);
ResponseUtils::output($response);